DigiUsher Kubernetes Cost Metrics Collector
====

Click here to jump straight to [installation](#setup-and-installation) steps.

Ready-to-deploy setup of components necessary for Kubernetes cost management and FinOps in DigiUsher.

The following open-source components are used:
- [Prometheus](https://github.com/prometheus-community/helm-charts/tree/main/charts/prometheus)
  - [kube-state-metrics](https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-state-metrics)
  - [prometheus-node-exporter](https://github.com/prometheus-community/helm-charts/tree/main/charts/prometheus-node-exporter)
  - [prometheus-pushgateway](https://github.com/walker-tom/helm-charts/tree/main/charts/prometheus-pushgateway)
- [kube-service-selectors](https://github.com/digiusher/helm-charts/tree/main/charts/kube-service-selectors)

## Prerequisites

Prerequisites are based on dependencies:
- Kubernetes 1.17+
- Helm 3+

## Description

Helm chart for the DigiUsher Kubernetes Collector project, which is created to collect Kubernetes resources information and share it with DigiUsher FinOps project - https://www.digiusher.com.

## Setup and installation

Once Helm has been set up correctly, add the repo as follows:

```
helm repo add digiusher https://digiusher.github.io/helm-charts
```

First, add a Kubernetes data source on the [DigiUsher Portal here](https://app.digiusher.com/cloud-account/connect). Choose a username and password (Tip: You can create a secure password with the command `openssl rand -hex 32`). The data source id will be generated by DigiUsher.

Run this command to start reporting data from the k8s cluster to DigiUsher after changing the data source id, username and password in the command:

```bash
helm install kube-cost-metrics-collector digiusher/kube-cost-metrics-collector \
--set prometheus.server.dataSourceId=<data-source-id> \
--set prometheus.server.username=<username> \
--set prometheus.server.password=<password> \
--namespace digiusher \
--create-namespace
```

## Upgrade
```bash
helm repo update digiusher

helm upgrade kube-cost-metrics-collector digiusher/kube-cost-metrics-collector \
--namespace digiusher
```

<details>
<summary>
Available configuration parameters
</summary>
The following table lists the commonly used configurable parameters of the Helm chart.

Parameter | Description
--------- | ------------------------------------------------
prometheus.server.dataSourceId | DigiUsher Kubernetes data source id
prometheus.server.username | username which is used on DigiUsher Kubernetes data source registration
prometheus.server.password | password which is used on DigiUsher Kubernetes data source registration
prometheus.kubeStateMetrics.enabled | set to false if external kube-state-metrics exists and accessible
prometheus.prometheus-node-exporter.enabled | set to false if external node-exporter exists and accessible
prometheus.prometheus-pushgateway.enabled | set to false if external pushgateway exists and accessible

Additional options are in [values.yaml](values.yaml). Alternatively run
```bash
helm show values digiusher/kube-cost-metrics-collector
```
</details>

<details>
<summary>
Advanced installation instructions (on prem)
</summary>

Override **digiusher** remote write target to send metrics to *DigiUsher*

```bash
helm install kube-cost-metrics-collector digiusher/kube-cost-metrics-collector \
--set prometheus.server.dataSourceId=<data-source-id> \
--set prometheus.server.username=<username> \
--set prometheus.server.password=<password> \
--set prometheus.server.remote_write[0].url=https://<ip-address>/storage/api/v2/write \
--set prometheus.server.remote_write[0].name=digiusher \
--namespace digiusher \
--create-namespace
```
</details>
